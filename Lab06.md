# Lab 6 Introduction to PCB Design

## Table of Contents

- [Lab 6 Introduction to PCB Design](#lab-6-introduction-to-pcb-design)
  - [Table of Contents](#table-of-contents)
  - [0 Repository Structure](#0-repository-structure)
    - [0.1 HW](#01-hw)
    - [0.2 SW](#02-sw)
    - [0.3 Resources](#03-resources)
    - [0.4 Git and Github](#04-git-and-github)
  - [1 Summary](#1-summary)
    - [1.1 Goals](#11-goals)
    - [1.2 Team Size](#12-team-size)
    - [1.3 Review](#13-review)
    - [1.4 Starter Files](#14-starter-files)
    - [1.5 Background](#15-background)
    - [1.6 Requirements Document](#16-requirements-document)
  - [2 Preparation](#2-preparation)
  - [3 Procedure](#3-procedure)
    - [3.1 Select an Enclosure for the System](#31-select-an-enclosure-for-the-system)
    - [3.2 Complete the Schematic](#32-complete-the-schematic)
    - [3.3 Complete the PCB](#33-complete-the-pcb)
    - [3.4 Assemble Your Cardboard PCB](#34-assemble-your-cardboard-pcb)
    - [3.5 Upload Your PCB to JLCPCB](#35-upload-your-pcb-to-jlcpcb)
    - [3.6 Complete the BOM](#36-complete-the-bom)
  - [4 Checkout](#4-checkout)
  - [5 Report](#5-report)
    - [5.1 Deliverables](#51-deliverables)
    - [5.2 Analysis and Discussion Questions](#52-analysis-and-discussion-questions)

---

## 0 Repository Structure

The typical explanation for the repo structure. Lab specific instructions can be
found further below.

### 0.1 HW

The `hw` folder should contain your schematic and board files for your PCB or
circuits. In labs 1-5 and 10, you will be creating schematics for your circuit
in EAGLE. A setup tutorial can be found
[here](https://www.shawnvictor.net/autodesk-eagle.html).

### 0.2 SW

The `sw` folder should contain your application firmware and software written
for the lab. The `sw/inc` folder contains firmware drivers written for you by
Professor Valvano. Feel free to write your own (in fact, in some labs, you may
be required to write your own).

You can place any other source files in the `sw` folder. TAs will look at the
files you create and/or modify for software quality and for running your
project.

### 0.3 Resources

A couple files are provided in the Resources folder so you don't have to keep
searching for that one TI document. Some of them are immediately useful, like
the TM4C datasheet. Others may be useful for your final project, like the
TM4C_System_Design_Guidelines page.

### 0.4 Git and Github

We will extensively use Git and Github for managing lab projects. This makes it
easier for TAs to grade and help debug the project by allowing us to see commit
histories, maintain a common project structure, and likewise, it makes it easier
for students to collaborate with partners, merge different codebases, and to
debug their work by having a history of commits.

Two common ways of using Git and Github are [Github Desktop](https://desktop.github.com/) and the [command line](https://git-scm.com/downloads).
[Tutorials](https://dev.to/mollynem/git-github--workflow-fundamentals-5496) are also abundant on the net for you to peruse. We've provided a cheatsheet for git
in the Resources folder.

It is highly recommended to make the most out of Git, even if you've never used
it before. Version control will save you a lot of suffering, and tools like Git
or SVN are ubiquitous in the industry.

A gitignore file is added to the root of this repo that may prevent specific
files from being tagged to the repo. This are typically autogenerated output
files we don't care about, but sometimes other stuff (like .lib files) falls
through that we want. Feel free to modify if necessary.

---

## 1 Summary

### 1.1 Goals

1. PCB layout using Eagle
2. Systems level approach to embedded system design
   - Mechanical considerations
   - Availability of parts (second source)
   - Cost considerations
   - Power considerations
   - Design for test

### 1.2 Team Size

This lab is done individualy.

> One is the loneliest number.

### 1.3 Review

1. Datasheets for the TM4C123GH6PM microcontroller (review layout for the 64 pin LQFP (low profile quad flat pack))
2. [Eagle setup tutorial](https://www.shawnvictor.net/autodesk-eagle.html)
3. [ECE319K spring break PCB camp](https://docs.google.com/document/d/1IH5vu2bckfjNhRgrgllNNQLeclb7rm3aPWbOFKYeGOE/edit?usp=sharing)
4. Valvano Eagle tutorial videos:
   1. [Importing Eagle library for new part](https://youtu.be/7MNkIBrr_UA)
   2. [Editing the Eagle schematic](https://youtu.be/ZneKCLUWy_I)
   3. [Changing PCB size to fit in box](https://youtu.be/yPVYe-lXOEI)
   4. [Placing the parts on PCB](https://youtu.be/a9Aywr4wLSE)
   5. [Routing power](https://youtu.be/BzV133ZuO5)
   6. [Routing ground](https://youtu.be/23cDxOABxm8)
   7. [Routing signals](https://youtu.be/nrS0r5j0Ke8)
   8. [Finishing up and creating CAM Gerber files](https://youtu.be/lMueM00M8HU)
5. [Jared's Eagle Tips and Tricks]()

### 1.4 Starter Files

1. Lab_6.sch
2. Lab_6.pcb
3. EE445L.lbr
4. lab6_parts.csv

### 1.5 Background

Considering the design cycle presented in Section 1.3 of the book, one starts by analyzing a problem, and then one generates a **requirements document** describing what the system must do. The output of the analysis phase is a list of specifications and constraints. The requirements document for Lab 6 is given in [`requirements_document.docx`](requirements_document.docx). The Preparation and Procedure sections of lab assignments address the design and implementation phases of the project. The lab assignment and your solution to it represents analysis and initial design, just part way through the design cycle in Figure 6.5. You will build no circuits and write no software.

As you know, commercial products are not manufactured using solder-less breadboards like the ones we use in ECE319K and ECE445L. Furthermore, commercial products do not include microcontroller boards like the LaunchPad. Implementing the embedded system on a PCB, which includes both the microcontroller and the external circuitry, will improve maintainability, testability, and reliability. It will also reduce the size, weight and cost of the system.

There are no specific requirements for this lab to minimize size, cost, or power, but you will be asked to estimate these parameters in your system. There are three considerations when designing a power efficient system. First, we need to make a **Power Budget**. This means we determine the maximum amount of power that can be supported by the power source. Second, we need to identify and analyze required **system tasks**. This means we determine the tasks that need to be performed by the system and estimate the power required to perform these tasks. It is important to consider timing of the tasks and synchronization to I/O events. For example, executing about once a second (e.g. smoke detector checking for fires) will require less power than executing exactly once a second (digital watch). One way the TI MSP430 family achieves very low power is it can run without a crystal oscillator, and the rate at which the microcontroller runs can be approximately set. For example, the 40-pin MSP430F2274 running at 1 MHz requires only 400 µA of supply current, whereas a Cortex M requires 10 to 100 times more current. The third consideration is to develop a **power strategy**. Having a strategy for power helps the power needed to perform the required system tasks to fit within the power budget. A Power Budget is a first order calculation that gives you a ballpark figure of the “total average current” supported by your power source. From the system specifications we are given how long the system must operate without replacing batteries, **tlife** (hours) (tlife is 24 hours in this lab). From the battery datasheet we determine the storage capacity of the battery, **E** (mAh). Be aware that for many batteries the storage capacity also depends on current, time, and temperature.

For this lab, the power budget is: **average current ≤ E / tlife**
- E = 2600mAh
- tlife = 24h

### 1.6 Requirements Document

Read through the [requirements document](requirements_document.docx) to gain an understanding of your assignment.

---

## 2 Preparation

1. Download the `EE445L.lbr` file to make sure you have the latest version (the GitHub should contain the latest version)
2. Receive the part number for your assigned DAC and op-amp from your TA

   | Part               | Component Type  | Datasheet                                                                         |
   |--------------------|-----------------|-----------------------------------------------------------------------------------|
   | AD5061BRJZ-1500RL7 | DAC             | [AD5061 datasheet](resources/part_datasheets/ad5061.pdf)                          |
   | AD5300BRMZ         | DAC             | [AD5300 datasheet](resources/part_datasheets/ad5300.pdf)                          |
   | AD8300ARZ          | DAC             | [AD8300 datasheet](resources/part_datasheets/ad5300.pdf)                          |
   | AD5541JRZ          | DAC             | [AD5541/AD5542 datasheet](resources/part_datasheets/ad5541_5542.pdf)              |
   | AD8604WARZ         | op-amp          | [AD8601/AD8602/AD8604 datasheet](resources/part_datasheets/ad8601_8602_8604.pdf)  |
   | AD8604ARQZ-R7      | op-amp          | [AD8601/AD8602/AD8604 datasheet](resources/part_datasheets/ad8601_8602_8604.pdf)  |
   | AD822ARZ           | op-amp          | [AD822 datasheet](resources/part_datasheets/ad822.pdf)                            |
   | AD823ARZ           | op-amp          | [AD823 datasheet](resources/part_datasheets/ad823.pdf)                            |
   | AD8542ARZ          | op-amp          | [AD8541/AD8542/AD8544 datasheet](resources/part_datasheets/ad8541_8542_8544.pdf)  |
   | RC4558D            | op-amp          | [RC4558 datasheet]() |
   | RC4558DR           | op-amp          | [RC4558 datasheet]() |
   | RC4558ID           | op-amp          | [RC4558 datasheet]() |
   | RC4558IP           | op-amp          | [RC4558 datasheet]() |
   | RC4558IPW          | op-amp          | [RC4558 datasheet]() |

3. Find the datasheets for the DAC and op-amp
4. Find the availability and prices for the DAC and op-amp
5. Find the symbols and footprints for the DAC and op-amp
   1. You can find symbols and footprints for parts from websites such as: [mouser](https://www.mouser.com/) and [snapeda](https://www.snapeda.com/)
6. Add the DAC and op-amp to the Lab 6 schematic
   1. You do not have to finish the schematic for preparation
   2. You do not have to add additional functionality beyond what is in the requirements document

---

## 3 Procedure

*Note: every part in your system must be added to a BOM (bill of materials), so keep a note of each component's cost*

### 3.1 Select an Enclosure for the System

1. Your PCB must fit within an enclosure
2. A larger box will allow for a larger PCB and make layout simpler
3. Select an enclosure from the following list (these enclosures can be found in the ECE445L parts chest):

   | Enclosure     | Manufacturer                  | Datasheet                                                                   |
   |---------------|-------------------------------|-----------------------------------------------------------------------------|
   | Hammond 1593Y | Hammond Manufacturing         | [Hammond 1593Y datasheet](resources/enclosure_datasheets/hammond-1593Y.pdf) |
   | PacTec XP     | PacTec                        | [PacTec XP datasheet](resources/enclosure_datasheets/pactec-XP.pdf)         |
   | Serpac 151    | Serpac Electronic Enclosures  | [Serpac 151 datasheet](resources/enclosure_datasheets/serpac-151.pdf)       |

4. Note the space you have within the enclosure for the PCB and sizes of the drill holes that you will need to place on your PCB later
5. During checkout, you will have to verify that your PCB fits inside of the enclosure that you selected
   
### 3.2 Complete the Schematic

*Note: When you are working on the schematic and/or the PCB, **KEEP BOTH EDITORS OPEN TO PREVENT DESYNC***

1. Add the DAC and op-amp to the schematic
2. Add the required components to complete the system
   1. It is okay to use through hole components for everything except the TM4C
   2. All IC should have a bypass capacitor
3. Add components to test the system
   1. The JTAG port allows your to download and run software on the microcontroller
   2. Add test points for analog signals
   3. Add a 16-pin logic-analyzer breakout (8x2 pin header), and connect 8 pins to different digital signals and 8 pins to GND
4. Route nets so that all components are connected correctly
5. Name every net within the schematic
   1. There should be **zero** nets with names like **N$0**
   2. To view all nets:
      1. View the **Design Manager**
      2. Select **Nets** from the **View** dropdown menu
      3. Select **Select all** within the **New Classes/Busses** section
      4. All nets within the schematic should appear in the **Nets** section
6. Execute an **Electrical Rule Check (ERC)** and fix any errors that exist
   1. Resistor and capacitors **MUST** have values
   2. Some errors can be allowed:
      1. Pin headers that have no value (they should still have names)
      2. Buttons that have no value (they should still have names)
      3. Others errors of a similar nature

### 3.3 Complete the PCB

*Note: When you are working on the schematic and/or the PCB, **KEEP BOTH EDITORS OPEN TO PREVENT DESYNC***

1. Click the **SCH/BRD** button to switch to the PCB
2. Edit the grid size to ensure all your components are placed in exact locations
   1. Set the grid size by typing `grid <number> <unit>` into the command line above the board
   2. Set the grid visibility by clicking the grid icon in the top left corner of the 
3. Resize the PCB area so that it corresponds to the enclosure that you selected
4. Place the components within the PCB area
   1. You cannot use auto-place functions (Eagle doesn't have any to begin with)
   2. All components must be placed by hand
   3. Intelligently placing your parts will make laying the traces much easier in the future
   4. Place all bypass capacitors as close to their respective ICs as possible
   5. Place all through hole components on the top side (SMD components can go on either side)
   6. Place components in a way to minimize trace lengths and cross-talk
   7. Place components that connect to each other next to each other
   8. Place polarized parts in the same orientation if possible
5. Route the components on your PCB
   1. [JLCPCB PCB capabilities](https://jlcpcb.com/capabilities/pcb-capabilities)
      1. View minimum clearance, minimum trace width and spacing, etc.
      2. Edit your **DRC** accordingly
   2. You cannot use auto-route functions
   3. All traces must be routed by hand
   4. Avoid loops because loops can pickup EM field noise
   5. Avoid 90 degree turns (convert them into two 45 degree turns)
   6. For beginners, it's easier to route your PCB if you keep all vertical traces on one side and all horizontal traces on the other side
   7. Do not use a ground pour for this PCB
      1. Place ground and power paths in the shape of a capital E
   8. Select traces with suitable widths
      1. [IPC-2221 PCB trace width calculator](http://www.circuitcalculator.com/wordpress/2006/01/31/pcb-trace-width-calculator/)
      2. [IPC-2152 PCB trace width calculator](https://twcalculator.app.protoexpress.com/)
      3. [Article on IPC-2152](https://resources.altium.com/p/using-ipc-2152-calculator-designing-standards)
      4. The copper on your board will have a thickness of 1oz
      5. Most of the signal traces in the class can be 7 to 10 mils
      6. Use 20 to 30 mil width traces for power, ground, and signals carrying large currents
   9. Select vias with suitable sizes
      1. [IPC-2221 PCB via calculator](http://circuitcalculator.com/wordpress/2006/03/12/pcb-via-calculator/)
6. Add silk screens that include:
   1. Your name (top silk)
   2. Your TAs initials (top silk)
   3. Date (top silk)
   4. Purpose of the board (top silk)
   5. All components must have visible labels (whichever side the component is on)
   6. Information to assist in construction and debugging (top silk)
7. Execute a **Design Rule Check (DRC)** and fix any errors that exist

### 3.4 Assemble Your Cardboard PCB

1. Click the **Layer Settings** button
2. Change the settings of the layers so the only visible layers are the **top** layers
3. Click the **Print** button
4. Set the scale to 1
5. Print or save the PDF
6. Click the **Layer Settings** button
7. Change the settings of the layers so the only visible layers are the **bottom** layers
8. Click the **Print** button
9. Set the scale to 1
10. Print or save the PDF
11. Cut out the boards and glue them to a piece of cardboard

### 3.5 Upload Your PCB to JLCPCB

1. Click the **CAM Processor** button in the top tool bar
2. Select **Export as ZIP**
3. Click the **Process Job** button
4. Save the zip file
5. Go to [jlcpcb.com](https://jlcpcb.com/)
6. Click the **Add gerber file** button
7. Select the zip file
8. Click the **Instant Quote** button
9. Take a screenshot of the screen for the report
   1.  If the PCB is smaller than 10000 mm<sup>2</sup> the calculated price will be $2.00
   2.  If the PCB is larger than 10000 mm<sup>2</sup> the calculated price will be greater than $2.00

### 3.6 Complete the BOM

1. Export your parts list from Eagle
   1. Open your project
   2. Click **File**
   3. Click **Export...**
   4. Click **BOM**
   5. Select csv as the file format
   6. The delimiter for the csv file from Eagle is `;` (which makes no sense because csv stands for: *comma-separated values*)
   7. Convert the csv's delimiter to `,` with the [eagle_bom_to_csv.py](resources/bom/eagle_bom_to_csv.py) script
      1. In windows, type `py eagle_bom_to_csv.py -h` to view the script's help function
      2. In ubuntu, type `python3 eagle_bom_to_csv.py -h` to view the script's help function
      3. If you have another way you'd prefer to convert your csv's delimiter, feel free to do that
   8. This BOM should contain all the parts within your schematic
1. Add any additional parts to your BOM that your system will contain that were not part of the board (enclosure, battery, etc)
2. Add a column for **price**
3. Add a column for **estimated current**
4. Fill out the **price** column with values found from:
   1. [lab6_parts.csv](resources/bom/lab6_parts.csv)
   2. [digikey](https://digikey.com/)
   3. [mouser](https://mouser.com/)
   4. [octopart](https://octopart.com/)
   5. It doesn't matter whether the prices you choose for the DAC and op-amp are the quantity 1 prices or the quantity 1000 prices
5. Fill out the **estimated current** column
   1. You only need to note the current of the TM4C123, DAC, op-amp, LM4041, and LEDs
   2. Find the current drawn by the TM4C123 from the [TM4C123 datasheet]()
   3. Find the current drawn by the DAC from its datasheet
   4. Find the current drawn by the op-amp from its datasheet
   5. Calculate the current drawn by the LM4041 with this equation: I = (3.3 - V<sub>REF</sub>) / R<sub>S</sub>
      1. V<sub>REF</sub> = reference voltage
      2. R<sub>S</sub> = impedance of the resistor between the LM4041 and 3.3V
   6. Calculate the voltage of the LEDs with this equation: I = (3.3 - V<sub>D</sub>) / R
      1. V<sub>D</sub> = diode voltage
      2. R = impedance of the resistor in series
6. Calculate the total cost of the system
7. Calculate the estimated total current draw of the system
8. Calculate how long the system can operate using the estimated total current

---

## 4 Checkout

1. You will execute an ERC and DRC to verify that your project is complete
2. Bring the printed PCB glued to the backs of cardboard to verify that your PCB fits within the enclosure you chose

---

## 5 Report

### 5.1 Deliverables

1. Objectives (requirements document)
2. Hardware design
   1. Final `.sch` file
   2. Final `.brd` file
   3. Screenshot of the JLC order screen
3. Software design
4. Measurement data
   1. Bill of Materials
   2. Total cost of the system
   3. Total estimated current

### 5.2 Analysis and Discussion Questions

1. Estimate how long the system would run on the 2600mAh battery